@using Microsoft.AspNetCore.Identity
@model LibraryManagementSystem.Models.AuthenticationModels.UserProfileModel

@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager
@{
    string avatarBase64 = "/assets/image/default/ava1.png"; // Đường dẫn mặc định
    if (SignInManager.IsSignedIn(User))
    {
        if (Model.Avatar != null)
        {
            avatarBase64 = $"data:image/png;base64,{Convert.ToBase64String(Model.Avatar)}";
        }
    }
}

<link href="~/features/auth/profile/Profile.css" rel="stylesheet" />

<div class="profile-container">
    <div class="left-box">
        <div class="general-information information-box">
            <form asp-action="UpdateAvatar" asp-controller="Account" enctype="multipart/form-data" class="form-avatar">
                <div class="avatar-box">
                    <img src="@avatarBase64" alt="Avatar" class="user-avatar" id="avatar-preview">
                    <div class="form-avatar-btn-box">
                        <label for="inp-avatar">
                            <i class="fa-solid fa-camera btn-avatar"></i>
                        </label>
                    </div>

                    <!-- Box chứa nút chấp nhận và hủy -->
                    <div class="form-avatar-selection-box">
                        <button type="button" class="btn-avatar-no">
                            <i class="fa-solid fa-x btn-avatar-icon-no"></i>
                        </button>
                        <button type="submit" class="btn-avatar-yes">
                            <i class="fa-solid fa-check btn-avatar-icon-yes"></i>
                        </button>
                    </div>

                    <input type="file" id="inp-avatar" name="inpAvatar" hidden />
                </div>
            </form>
            <div class="user-username">@Model.UserName</div>
            <!-- <div class="user-username">Đỗ Thanh Hùng</div> -->
            <div class="general-infomations">
                <div class="general-info">
                </div>
            </div>
        </div>
    </div>
    <div class="right-box">
        <div class="personal-information information-box">
            <form asp-action="UpdatePersonalInfo" asp-controller="Account" class="form-personal">
                <div class="personal-info-title">
                    <h2>
                        Personal Information
                        <button type="button" class="personal-edit-btn"><i class="fa-solid fa-pencil icon"></i></button>
                    </h2>
                </div>
                <div class="info-box">
                    <div class="info-icon">
                        <i class="fa-solid fa-id-badge icon"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-title">Căn cước công dân</div>
                        <div class="info-value">
                            <input type="text" asp-for="Pid" class="inp-personal inp-no-decor" pattern="[0-9]{12}" required readonly />
                        </div>
                    </div>
                </div>
                <div class="info-box">
                    <div class="info-icon">
                        <i class="fa-regular fa-user icon"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-title">Họ và Tên</div>
                        <div class="info-value">
                            <input type="text" asp-for="Fullname" class="inp-personal inp-no-decor" required readonly />
                        </div>
                    </div>
                </div>
                <div class="info-box">
                    <div class="info-icon">
                        <i class="fa-solid fa-transgender icon"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-title">Giới tính</div>
                        <div class="info-value">
                            <input type="text" asp-for="Gender" class="inp-personal inp-no-decor" required readonly />
                        </div>
                    </div>
                </div>
                <div class="info-box">
                    <div class="info-icon">
                        <i class="fa-solid fa-calendar-days icon"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-title">Ngày sinh</div>
                        <div class="info-value">
                            <input type="date" asp-for="Dob" class="inp-personal inp-no-decor" pattern="[0-9]{2}-[0-9]{2}-[0-9]{4}" required readonly />
                        </div>
                    </div>
                </div>
                <div class="info-box">
                    <div class="info-icon">
                        <i class="fa-solid fa-location-dot icon"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-title">Địa chỉ</div>
                        <div class="info-value info-value-address">
                            <input type="text" value="40/14 Đường số 27, Sơn Kỳ, Tân Phú, TP.HCM aaaaaaaaaaaaaaaaaaa aaaaaaaaaaaaaa" required class="inp-personal inp-no-decor" readonly />
                        </div>
                    </div>
                </div>
                <div class="btn-personal-box">
                    <button type="submit" class="btn-personal-save btn btn-success">Save</button>
                    <button type="reset" class="btn-personal-reset btn btn-outline-secondary">Cancel</button>
                </div>
            </form>
        </div>
        <div class="other-information information-box">
            <div class="personal-info-title">
                <h2>Other Information</h2>
            </div>
            <div class="info-box">
                <div class="info-icon">
                    <i class="fa-regular fa-envelope icon"></i>
                </div>
                <div class="info-content">
                    <div class="info-title">Email <button type="button" class="email-edit-btn btn-no-decor"><i class="fa-solid fa-pencil"></i></button></div>
                    <div class="info-value">
                        <input type="email" asp-for="Email" class="inp inp-no-decor" readonly required />
                    </div>
                    <dialog id="dialog-confirm-email">
                        <form asp-action="UpdateEmail" asp-controller="Account" class="form-confirm-email">
                            <div class="mb-3">
                                <label for="inp-email-confirm" class="form-label">Email mới</label>
                                <input type="email" asp-for="NewEmail" placeholder="example@mail.com" id="inp-email-confirm" required class="form-control" />
                            </div>
                            <label for="inp-OTP-confirm" class="form-label">Mã xác nhận</label>
                            <div class="input-group mb-3">
                                <input type="text" asp-for="OTP" class="form-control" id="inp-OTP-confirm" required placeholder="OTP">
                                <button class="btn btn-outline-secondary btn-send-otp" type="button" id="button-addon2">Gửi mã</button>
                            </div>
                            <div>
                                <p id="otpStatus" class="alert"></p>
                            </div>
                            <div class="right">
                                <button type="submit" class="btn-email-save btn btn-success">Lưu</button>
                                <button type="reset" class="btn-email-reset btn btn-outline-secondary">Hủy bỏ</button>
                            </div>
                        </form>
                    </dialog>
                </div>
            </div>
            <div class="info-box">
                <div class="info-icon">
                    <i class="fa-solid fa-phone icon"></i>
                </div>
                <div class="info-content">
                    <div class="info-title">Số Điện Thoại <button type="button" class="phone-edit-btn btn-no-decor"><i class="fa-solid fa-pencil"></i></button></div>
                    <div class="info-value">
                        <input type="text" asp-for="Phone" class="inp inp-no-decor" readonly />
                    </div>
                    <dialog id="dialog-confirm-phone">
                        <form asp-action="UpdatePhone" asp-controller="Account" class="form-confirm-phone">
                            <div class="mb-3">
                                <label for="inp-phone-confirm" class="form-label">Số điện thoại</label>
                                <input type="text" asp-for="NewPhone" pattern="[0-9]{10}" id="inp-phone-confirm" required placeholder="0903030303" class="form-control" />
                            </div>
                            <div>
                                <button type="submit" class="btn-phone-save btn btn-success">Lưu</button>
                                <button type="reset" class="btn-phone-reset btn btn-outline-secondary">Hủy bỏ</button>
                            </div>
                        </form>
                    </dialog>
                </div>
            </div>
        </div>
    </div>
</div>
@* <div class="user-cover">
    <img src="cover-1.jpg" alt="User Cover" class="cover-img">
</div> *@

<script>
    $(document).ready(function () {
      const $avatarBox = $('.avatar-box');
      const $btnBox = $('.form-avatar-btn-box');
      const $selectionBox = $('.form-avatar-selection-box');
      const $inputAvatar = $('#inp-avatar');
      const $previewImg = $('#avatar-preview');
      const $prevImg = $('.user-avatar').attr("src");
      // Khi chọn file
      $inputAvatar.on('change', function (event) {
        const file = event.target.files[0];

        if (file) {
          const reader = new FileReader();

          reader.onload = function (e) {
            // Hiển thị ảnh xem trước
            $previewImg.attr('src', e.target.result);

            // Hiển thị nút Yes/No, ẩn nút camera
            $btnBox.hide();
            $selectionBox.show();
          };

          reader.readAsDataURL(file);
        }
      });

      // Xử lý khi người dùng bấm nút "Yes"
      $('.btn-avatar-yes').on('click', function () {
        // Ẩn các nút Yes/No, hiển thị lại nút camera
        $selectionBox.hide();
        $btnBox.show();
      });

      // Xử lý khi người dùng bấm nút "No"
      $('.btn-avatar-no').on('click', function () {
        // Reset lại input và ảnh
        $inputAvatar.val(''); // Xóa file đã chọn
        $previewImg.attr('src', $prevImg); // Reset về ảnh mặc định

        // Ẩn các nút Yes/No, hiển thị lại nút camera
        $selectionBox.hide();
        $btnBox.show();
      });

      $('.personal-edit-btn').on('click', function () {
        // Ẩn các nút Yes/No, hiển thị lại nút camera
        $('.personal-edit-btn').hide();
        $('.btn-personal-box').show();
        $('.inp-personal').removeClass("inp-no-decor");
        $('.inp-personal').removeAttr("readonly");

      });

      $('.btn-personal-reset').on('click', function () {
        // Ẩn các nút Yes/No, hiển thị lại nút camera
        $('.personal-edit-btn').show();
        $('.btn-personal-box').hide();
        $('.inp-personal').addClass("inp-no-decor");
        $('.inp-personal').attr("readonly", "true");
      });

      $('.email-edit-btn').on('click', function () {
        $('#dialog-confirm-email')[0].showModal();
      })
      $('.phone-edit-btn').on('click', function () {
        $('#dialog-confirm-phone  ')[0].showModal();
      })
    });

    $(document).on('click', '.btn-email-reset', function () {
      $('#dialog-confirm-email')[0].close();
    });

    $(document).on('click', '.btn-phone-reset', function () {
      $('#dialog-confirm-phone')[0].close();
    });

    $(document).on('click', '.btn-send-otp', function () {
        const email = $("#inp-email-confirm").val();
      $.ajax({
        url: '/Account/SendOTP', // Đường dẫn đến Controller trong MVC
        method: 'POST',
        contentType: 'application/json',
            data: JSON.stringify({ email: email,OTP:"" }),
        success: function (response) {
        if (JSON.parse(response).IsSuccess) {
                $('#otpStatus').show();
                $('#otpStatus').html(`OTP đã được gửi đến ${email}.`);
                $('#otpStatus').addClass('alert-success');
                $('#otpStatus').removeClass('alert-danger');
            } else {
                $('#otpStatus').show();
                $('#otpStatus').html('Không thể gửi OTP. Vui lòng thử lại!');
                $('#otpStatus').removeClass('alert-success');
                $('#otpStatus').addClass('alert-danger');
            }
        },
        error: function (xhr) {
          $('#otpStatus').show();
          $('#otpStatus').html('Không thể gửi OTP. Vui lòng thử lại !');
          $('#otpStatus').removeClass('alert-success');
          $('#otpStatus').addClass('alert-danger');
        }
      });
    })
    $(document).on('submit', '.form-confirm-email', function (e) {
        e.preventDefault()
      $.ajax({
        url: '/Account/CheckOTP', // Đường dẫn đến Controller trong MVC
        method: 'POST',
        contentType: 'application/json',
            data: JSON.stringify({ email: "", OTP: $("#inp-OTP-confirm").val() }),
        success: function (response) {
            if (JSON.parse(response).IsSuccess) {
            $('.form-confirm-email').submit();
          } else {
            $('#otpStatus').show();
            $('#otpStatus').html('Mã xác nhận không hợp lệ!');
            $('#otpStatus').removeClass('alert-success');
            $('#otpStatus').addClass('alert-danger');
            
          }
        },
        error: function (xhr) {
          $('#otpStatus').show();
          $('#otpStatus').html('Mã xác nhận không hợp lệ!');
          $('#otpStatus').removeClass('alert-success');
          $('#otpStatus').addClass('alert-danger');
            e.preventDefault();
        }
      });
    });
</script>