
@model IEnumerable<LibraryManagementSystem.Models.Author>

@{
    ViewData["Title"] = "Index";
    var countryNames = new Dictionary<string, string>
    {
        { "00", "Không rõ" },
        { "VN", "Vietnam" },
        { "EN", "England" },
        { "US", "United States" },
        { "FR", "France" },
        { "JP", "Japan" },
        { "KR", "South Korea" },
        { "CN", "China" },
        { "DE", "Germany" },
        { "AU", "Australia" },
        { "IT", "Italy" },
        { "ES", "Spain" },
        { "CA", "Canada" },
        { "IN", "India" },
        { "BR", "Brazil" }
    };
    int pageNumber = ViewBag.PageNumber ?? 1;
    int pageSize = ViewBag.PageSize ?? 10;
    int totalPages = ViewBag.TotalPages ?? 1;
}

<h1>Tác giả</h1>

<p>
    <a asp-action="Create">Thêm tác giả mới</a>
    <th class="col-md-2">&nbsp;</th>
    @if (ViewBag.PageNumber > 1)
    {
        <th class="col-md-2">&nbsp;</th>
        <a asp-action="Index" class="btn btn-success" asp-route-pageNumber="@(ViewBag.PageNumber - 1)"
           asp-route-pageSize="@ViewBag.PageSize"
           asp-route-Id="@ViewData["Id"]" asp-route-Name="@ViewData["Name"]"
           asp-route-Gender="@ViewData["Gender"]" asp-route-Nation="@ViewData["Nation"]"
           asp-route-NhaXuatBan="@ViewData["Status"]">
            Trang trước
        </a>
    }
    @if (ViewBag.PageNumber < ViewBag.TotalPages)
    {
        <th class="col-md-2">&nbsp;</th>
        <a asp-action="Index" class="btn btn-success" asp-route-pageNumber="@(ViewBag.PageNumber + 1)"
           asp-route-pageSize="@ViewBag.PageSize"
           asp-route-Id="@ViewData["Id"]" asp-route-Name="@ViewData["Name"]"
           asp-route-Gender="@ViewData["Gender"]" asp-route-Nation="@ViewData["Nation"]"
           asp-route-NhaXuatBan="@ViewData["Status"]">
            Trang sau
        </a>
    }
    <div class="d-flex align-items-center">
        <!-- Hiển thị số trang -->
        @{
            int startPage = Math.Max(1, ViewBag.PageNumber - 3);
            int endPage = Math.Min(ViewBag.TotalPages, ViewBag.PageNumber + 3);
        }

        @if (ViewBag.TotalPages > 2)
        {
            @for (int i = startPage; i <= endPage; i++)
            {
                <th class="col-md-1">
                    &nbsp;
                    @if (i == ViewBag.PageNumber)
                    {
                        <!-- Hiển thị ô input cho trang hiện tại -->
                        <input type="number" id="pageNumberInput" min="1" max="@ViewBag.TotalPages" value="@ViewBag.PageNumber" size="1" class="form-control d-inline" style="width: auto;" />
                        <a id="pageLink" class="btn btn-warning ms-2" href="#">
                            GO
                        </a>
                    }
                    else
                    {
                        <!-- Hiển thị các trang khác dưới dạng link -->
                        <a class="btn btn-outline-primary"
                           asp-action="Index"
                           asp-route-pageNumber="@i"
                           asp-route-pageSize="@ViewBag.PageSize"
                           asp-route-Id="@ViewData["Id"]"
                           asp-route-Name="@ViewData["Name"]"
                           asp-route-Gender="@ViewData["Gender"]" asp-route-Nation="@ViewData["Nation"]"
                           asp-route-NhaXuatBan="@ViewData["Status"]">
                            @i
                        </a>
                    }
                </th>
            }
        }
    </div>
    </tr>
</p>

<!-- Form lọc -->
<form method="get" action="@Url.Action("Index")" class="mb-4">
    <div class="row">
        <hr />
        <div class="col-md-2">
            <input type="text" name="Id" class="form-control" placeholder="ID" value="@ViewData["Id"]" />
        </div>
        <div class="col-md-2">
            <input type="text" name="Name" class="form-control" placeholder="Tên tác giả" value="@ViewData["Name"]" />
        </div>
        <div class="col-md-2">
            <select name="Gender" class="form-control" asp-items="ViewBag.GenderOptions"></select>
        </div>
        <div class="col-md-2">
            <select name="Nation" class="form-control" asp-items="ViewBag.NationOptions"></select>
        </div>
        <div class="col-md-2">
            <select name="Status" class="form-control" asp-items="ViewBag.StatusOptions"></select>
        </div>
        <div class="form-group">
            <label for="pageSize">Số lượng tác giả hiển thị tối đa trong trang</label>
            <input type="number" class="form-control" id="pageSize" name="pageSize" value="@ViewBag.PageSize" min="1" />
        </div>
        <div class="col-md-2">
            <br />
            <button type="submit" class="btn btn-primary">Lọc</button> Tổng sách: @ViewBag.TotalBooks
        </div>
        <hr />
    </div>
</form>

<table class="table">
    <thead>
        <tr>
            <th class="text-center">STT</th>
            <th class="text-center">@Html.DisplayNameFor(model => model.Id)</th>
            <th>
                @Html.DisplayNameFor(model => model.Name)
            </th>
            <th>
                Sách liên kết
            </th>
            <th class="text-center">
                @Html.DisplayNameFor(model => model.Gender)
            </th>
            <th class="text-center">
                @Html.DisplayNameFor(model => model.Nation)
            </th>
                <th class="text-center">
                    @Html.DisplayNameFor(model => model.Status)
                </th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @{
          int stt = (pageNumber - 1) * pageSize + 1;
          foreach (var item in Model)
          {
            <tr>
                <td class="text-center">@stt</td>
                <td class="text-center">@Html.DisplayFor(modelItem => item.Id)</td>
                <td>
                    @Html.DisplayFor(modelItem => item.Name)
                </td>
                    <td>
                        @if (item.Books != null && item.Books.Any())
                        {
                            <ul style=" padding-left: 0;">
                                @foreach (var book in item.Books)
                                {
                                    <li>@book.Name</li>
                                }
                            </ul>
                        }
                        else
                        {
                            <span>Không có sách liên kết</span>
                        }
                    </td>
                <td class="text-center">
                        @if (item.Gender == 1)
                        {
                        <span>Nam</span>
                        }
                        else if (item.Gender == 0)
                        {
                        <span>Nữ</span>
                        }
                        else
                        {
                        <span>Không tiết lộ</span>
                        }
                </td>
                <td class="text-center">
                    @if (countryNames.ContainsKey(item.Nation))
                    {
                        <span>@countryNames[item.Nation]</span>
                    }
                    else
                    {
                        <span>Unknown</span>
                    }
                </td>
                
                        <td class="text-center">
                            @if (item.Status == 1)
                            {
                                <span>Đang hoạt động</span>
                            }
                            else if (item.Status == 0)
                            {
                                <span>Ngừng hoạt động</span>
                            }
                            else
                            {
                                <span>Không rõ</span>
                            }
                        </td>
                <td class="text-center">
                            <div style="white-space: nowrap;">
                                |<a style="text-decoration: none;" asp-action="Edit" asp-route-id="@item.Id">Chỉnh sửa</a>|<br />
                                |<a style="text-decoration: none;" asp-action="Delete" asp-route-id="@item.Id">Xóa</a>|
                            </div>
                </td>
            </tr>
            stt++;
          }
        }
    </tbody>
</table>

<div id="pagination-buttons" style="text-align: right;">
    @if (ViewBag.PageNumber > 1)
    {
        <a id="prev-button" class="btn btn-success"
           asp-action="Index" asp-route-pageNumber="@(ViewBag.PageNumber - 1)"
           asp-route-pageSize="@ViewBag.PageSize"
           asp-route-Id="@ViewData["Id"]" asp-route-Name="@ViewData["Name"]"
           asp-route-Gender="@ViewData["Gender"]" asp-route-Nation="@ViewData["Nation"]"
           asp-route-NhaXuatBan="@ViewData["Status"]">
            Trang trước
        </a>
    }
    @if (ViewBag.PageNumber < ViewBag.TotalPages)
    {
        <a id="next-button" class="btn btn-success"
           asp-action="Index" asp-route-pageNumber="@(ViewBag.PageNumber + 1)"
           asp-route-pageSize="@ViewBag.PageSize"
           asp-route-Id="@ViewData["Id"]" asp-route-Name="@ViewData["Name"]"
           asp-route-Gender="@ViewData["Gender"]" asp-route-Nation="@ViewData["Nation"]"
           asp-route-NhaXuatBan="@ViewData["Status"]">
            Trang sau
        </a>
    }
    <button id="scrollToTop2" class="btn btn-secondary ms-2">↑</button>
</div>
<div class="text-center" class="d-flex align-items-center">
    @if (ViewBag.TotalPages > 1)
    {
        @for (int i = startPage; i <= endPage; i++)
        {
            <th class="col-md-1">
                &nbsp;
                @if (i == ViewBag.PageNumber)
                {
                    <button id="scrollToTop" class="btn btn-secondary ms-2">↑</button>
                }
                else
                {
                    <!-- Hiển thị các trang khác dưới dạng link -->
                    <a class="btn btn-outline-primary"
                       asp-action="Index"
                       asp-route-pageNumber="@i"
                       asp-route-pageSize="@ViewBag.PageSize"
                       asp-route-Id="@ViewData["Id"]"
                       asp-route-Name="@ViewData["Name"]"
                       asp-route-Gender="@ViewData["Gender"]" asp-route-Nation="@ViewData["Nation"]"
                       asp-route-NhaXuatBan="@ViewData["Status"]">
                        @i
                    </a>
                }
            </th>
        }
    }
    <h4>Trang @ViewBag.PageNumber / @ViewBag.TotalPages</h4>
</div>
<hr />
@if (User.IsInRole("Admin"))
{
    <div>
        <a asp-action="Create" class="btn btn-success">Thêm sách mới</a>
    </div>
}


<script>
    document.addEventListener('keydown', function (event) {
        if (event.key === 'ArrowLeft') { // Phím mũi tên trái
            var prevButton = document.getElementById('prev-button');
            if (prevButton) {
                window.location.href = prevButton.href; // Chuyển đến trang trước
            }
        } else if (event.key === 'ArrowRight') { // Phím mũi tên phải
            var nextButton = document.getElementById('next-button');
            if (nextButton) {
                window.location.href = nextButton.href; // Chuyển đến trang sau
            }
        }
    });
</script>

<script>
    // JavaScript để giữ lại các tham số lọc khi thay đổi trang
    document.getElementById("pageLink").addEventListener("click", function (event) {
        event.preventDefault(); // Ngăn chặn hành động mặc định của liên kết

        // Lấy giá trị nhập từ input
        let pageNumber = parseInt(document.getElementById("pageNumberInput").value);

        // Kiểm tra giá trị nhập hợp lệ
        if (isNaN(pageNumber) || pageNumber < 1) {
            pageNumber = 1;  // Nếu không hợp lệ, mặc định về 1
        }
        if (pageNumber > @ViewBag.TotalPages) {
            pageNumber = @ViewBag.TotalPages;  // Nếu lớn hơn số trang tổng, chỉnh về max
        }

        // Cập nhật lại giá trị input để phản ánh trang đang chọn
        document.getElementById("pageNumberInput").value = pageNumber;

        // Lấy tất cả các tham số lọc từ form
        const form = document.querySelector('form');
        const formData = new FormData(form);

        // Xây dựng URL với các tham số lọc hiện tại và trang
        let newUrl = `@Url.Action("Index", "Author")?`;

        // Duyệt qua các tham số lọc và thêm vào URL
        for (let [key, value] of formData.entries()) {
            if (value) {
                newUrl += `${key}=${encodeURIComponent(value)}&`;
            }
        }

        // Thêm pageNumber vào URL
        newUrl += `pageNumber=${pageNumber}`;

        // Điều hướng trang đến URL mới
        window.location.href = newUrl;
    });
</script>
<script>
    document.getElementById("scrollToTop").addEventListener("click", function () {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
</script>
<script>
    document.getElementById("scrollToTop2").addEventListener("click", function () {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
</script>